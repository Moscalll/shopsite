<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '用户注册'">用户注册</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
</head>

<body>
    <div th:replace="index/fragments :: navbar"></div>

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-7">
                <div class="card border-0 position-relative" style="box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
                    <!-- 返回首页箭头 - 卡片左上角 -->
                    <a th:href="@{/}" class="position-absolute top-0 start-0 m-3 text-decoration-none"
                        style="z-index: 10; color: #6c757d; font-size: 1.5rem;" title="返回首页">
                        <i class="bi bi-arrow-left-circle"></i>
                    </a>

                    <div class="card-body p-4">
                        <h2 class="mb-4 text-center text-muji-dark">新用户注册</h2>

                        <!-- 表单提交到控制器端点，不是API端点 -->
                        <form th:action="@{/register}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <div th:if="${registrationSuccess}" class="alert alert-success alert-dismissible fade show"
                                role="alert">
                                注册成功！请 <a th:href="@{/login}" class="alert-link">登录</a>。
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            <div th:if="${registrationError}" class="alert alert-danger alert-dismissible fade show"
                                role="alert">
                                注册失败：<span th:text="${registrationError}"></span>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="username" class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="username" name="username" required
                                        placeholder="输入用户名" th:value="${username}">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required
                                        placeholder="输入邮箱地址" th:value="${email}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">密码</label>
                                    <input type="password" class="form-control" id="password" name="password" required
                                        placeholder="输入密码">
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="confirmPassword" class="form-label">确认密码</label>
                                    <input type="password" class="form-control" id="confirmPassword"
                                        name="confirmPassword" required placeholder="再次输入密码">
                                    <div class="invalid-feedback" id="passwordMismatchFeedback">
                                        两次输入的密码不一致！
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="role" class="form-label">注册类型</label>
                                <select class="form-select" id="role" name="role" required>
                                    <option value="CUSTOMER" selected>客户</option>
                                    <option value="MERCHANT">商户</option>
                                </select>
                                <small class="form-text text-muted">选择您的账户类型：客户可以购买商品，商户可以上架商品</small>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    我已阅读并同意 <a href="#" class="text-decoration-none" data-bs-toggle="modal"
                                        data-bs-target="#termsModal">服务条款</a> 和 <a href="#" class="text-decoration-none"
                                        data-bs-toggle="modal" data-bs-target="#privacyModal">隐私政策</a>
                                </label>
                            </div>

                            <!-- 服务条款弹窗 -->
                            <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel"
                                aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="termsModalLabel">服务条款</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <h6>1. 服务说明</h6>
                                            <p>本平台为用户提供在线购物服务，包括商品浏览、购买、订单管理等服务。用户在使用本平台服务时，应当遵守相关法律法规和本服务条款。</p>

                                            <h6>2. 用户账户</h6>
                                            <p>用户注册账户时，应当提供真实、准确、完整的个人信息。用户对其账户和密码的安全负责，不得将账户信息泄露给第三方。</p>

                                            <h6>3. 商品信息</h6>
                                            <p>平台上的商品信息由商户提供，平台不对商品信息的真实性、准确性、完整性承担责任。用户在购买商品前，应当仔细阅读商品详情。</p>

                                            <h6>4. 订单与支付</h6>
                                            <p>用户下单后，订单即成立。用户应当按照订单约定的价格和方式支付货款。平台保留在特殊情况下取消订单的权利。</p>

                                            <h6>5. 退换货政策</h6>
                                            <p>商品退换货政策按照相关法律法规和商户规定执行。已发货的订单无法取消，如需退换货，请联系商户或客服。</p>

                                            <h6>6. 知识产权</h6>
                                            <p>平台上的所有内容，包括但不限于文字、图片、商标、标识等，均受知识产权法保护。未经授权，不得擅自使用。</p>

                                            <h6>7. 免责声明</h6>
                                            <p>平台不对因不可抗力、网络故障、系统维护等原因导致的服务中断或数据丢失承担责任。</p>

                                            <h6>8. 条款修改</h6>
                                            <p>平台有权随时修改本服务条款，修改后的条款将在平台上公布。用户继续使用平台服务即视为接受修改后的条款。</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">关闭</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 隐私政策弹窗 -->
                            <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel"
                                aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="privacyModalLabel">隐私政策</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <h6>1. 信息收集</h6>
                                            <p>我们收集您在使用平台服务时主动提供的信息，包括但不限于：用户名、邮箱地址、密码、收货地址、订单信息等。</p>

                                            <h6>2. 信息使用</h6>
                                            <p>我们使用收集的信息用于：</p>
                                            <ul>
                                                <li>提供、维护和改进平台服务</li>
                                                <li>处理您的订单和交易</li>
                                                <li>发送订单状态、发货通知等重要信息</li>
                                                <li>提供客户支持和响应您的询问</li>
                                                <li>进行数据分析，改善用户体验</li>
                                            </ul>

                                            <h6>3. 信息保护</h6>
                                            <p>我们采用行业标准的安全措施保护您的个人信息，包括数据加密、访问控制等技术手段。我们不会向第三方出售、出租或分享您的个人信息，除非：</p>
                                            <ul>
                                                <li>获得您的明确同意</li>
                                                <li>法律法规要求</li>
                                                <li>为提供您要求的服务所必需</li>
                                            </ul>

                                            <h6>4. Cookie使用</h6>
                                            <p>我们使用Cookie技术来改善用户体验，包括记住您的登录状态、购物车内容等。您可以通过浏览器设置拒绝Cookie，但这可能影响部分功能的使用。
                                            </p>

                                            <h6>5. 第三方服务</h6>
                                            <p>我们可能使用第三方服务提供商来协助运营平台，这些服务提供商仅在提供服务所必需的范围内访问您的信息。</p>

                                            <h6>6. 信息保留</h6>
                                            <p>我们会在您使用平台服务期间保留您的信息，并在您注销账户后的一定期限内保留必要信息，以履行法律义务和解决争议。</p>

                                            <h6>7. 您的权利</h6>
                                            <p>您有权：</p>
                                            <ul>
                                                <li>访问、更正或删除您的个人信息</li>
                                                <li>撤回您对信息处理的同意</li>
                                                <li>要求我们停止处理您的个人信息</li>
                                                <li>投诉或举报隐私问题</li>
                                            </ul>

                                            <h6>8. 政策更新</h6>
                                            <p>我们可能不时更新本隐私政策。更新后的政策将在平台上公布，我们建议您定期查看。继续使用平台服务即视为接受更新后的政策。</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">关闭</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success w-100 mb-3">
                                <i class="bi bi-person-plus me-2"></i>注册新账户
                            </button>
                        </form>

                        <div class="text-center mt-3 pt-2 border-top">
                            <p class="mb-0">
                                已有账户？ <a th:href="@{/login}" class="text-decoration-none fw-medium">去登录</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="index/fragments :: footer"></div>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
        // 表单验证
        document.querySelector('form').addEventListener('submit', function (e) {
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const mismatchFeedback = document.getElementById('passwordMismatchFeedback');

            let isValid = true;

            // 1. 重置验证状态
            passwordInput.classList.remove('is-invalid');
            confirmPasswordInput.classList.remove('is-invalid');

            // 2. 密码长度验证
            if (passwordInput.value.length < 6) {
                e.preventDefault();
                passwordInput.classList.add('is-invalid');
                // 简单处理长度错误（可以添加专门的 feedback div）
                alert('密码长度至少需要6个字符！');
                isValid = false;
            }

            // 3. 密码匹配验证 (在长度验证后执行)
            if (passwordInput.value !== confirmPasswordInput.value) {
                e.preventDefault();
                confirmPasswordInput.classList.add('is-invalid');
                // 注意：因为使用了 is-invalid，Bootstrap 会自动显示 .invalid-feedback
                isValid = false;
            }

            return isValid;
        });
    </script>
</body>

</html>